<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kukyquiz</title>
  <style>
    :root {
      --bg: #2e261f;
      --card: #3a3229;
      --muted: #b8a99a;
      --text: #f2e9df;
      --primary: #22c55e;
      --primary-ink: #052e16;
      --danger: #ef4444;
      --warning: #fbbf24;
      --ring: #4a3e33;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: clamp(12px, 4vw, 24px);
    }
    .wrap { width: min(800px, 100%); max-width: 100%; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0));
      border: 1px solid var(--ring);
      border-radius: 20px;
      padding: clamp(12px, 3vw, 20px);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    header { display: flex; gap: clamp(8px, 2vw, 12px); align-items: center; margin-bottom: clamp(8px, 2vw, 12px); }
    header .logo {
      width: clamp(32px, 8vw, 42px);
      height: clamp(32px, 8vw, 42px);
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), #4ade80);
      display: grid;
      place-items: center;
      color: var(--primary-ink);
      font-weight: 800;
      font-size: clamp(1rem, 4vw, 1.5rem);
    }
    header h1 { font-size: clamp(1rem, 3vw, 1.1rem); margin: 0; }
    .bar { height: 8px; background: #1a120a; border: 1px solid var(--ring); border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), #4ade80); transition: width .35s ease; }
    .qbox { margin-top: clamp(12px, 3vw, 16px); display: grid; gap: clamp(10px, 2.5vw, 14px); }
    .q { font-size: clamp(1rem, 3vw, 1.05rem); line-height: 1.5; }
    .choices { display: grid; gap: clamp(8px, 2vw, 10px); }
    .btn {
      appearance: none;
      border: 1px solid var(--ring);
      background: #241d16;
      color: var(--text);
      padding: clamp(8px, 2.5vw, 12px) clamp(10px, 3vw, 14px);
      border-radius: 14px;
      cursor: pointer;
      text-align: left;
      font-size: clamp(0.9rem, 2.8vw, 1rem);
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover { transform: translateY(-1px); border-color: #5e4f3f; }
    .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(34,197,94, .15); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .btn.correct { background: rgba(34,197,94,.14); border-color: var(--primary); }
    .btn.wrong { background: rgba(239, 68, 68, .16); border-color: var(--danger); }
    .foot { display: flex; justify-content: space-between; align-items: center; margin-top: clamp(6px, 1.5vw, 8px); flex-wrap: wrap; gap: 10px; }
    .muted { color: var(--muted); }
    .action { display: flex; gap: clamp(6px, 1.5vw, 10px); }
    .pill {
      border: 1px solid var(--ring);
      padding: clamp(6px, 1.5vw, 8px) clamp(8px, 2vw, 12px);
      border-radius: 999px;
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
    }
    .cta {
      background: linear-gradient(135deg, var(--primary), #4ade80);
      color: var(--primary-ink);
      border: none;
      padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 14px);
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .cta:disabled { opacity: .7; cursor: not-allowed; }
    .result { display: grid; gap: clamp(8px, 2vw, 12px); text-align: center; padding: clamp(8px, 2vw, 10px) 4px; }
    .result h2 { margin: clamp(4px, 1vw, 6px) 0 0; font-size: clamp(1.2rem, 3.5vw, 1.5rem); }
    .result .score { font-size: clamp(1.5rem, 5vw, 2rem); font-weight: 800; }
    .review { margin-top: clamp(8px, 2vw, 10px); display: grid; gap: clamp(8px, 2vw, 10px); }
    details { background: #241d16; border: 1px solid var(--ring); border-radius: 12px; padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px); }
    details summary { cursor: pointer; font-size: clamp(0.9rem, 2.8vw, 1rem); }
    .tag {
      display: inline-block;
      padding: .2rem .5rem;
      border-radius: .5rem;
      margin-left: .4rem;
      font-size: clamp(0.65rem, 2vw, 0.75rem);
      border: 1px solid var(--ring);
      color: var(--muted);
    }
    #loadmsg {
      margin-top: clamp(4px, 1vw, 6px);
      color: var(--muted);
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid var(--muted);
      border-top: 2px solid var(--text);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body { padding: 12px; }
      .card { border-radius: 16px; padding: 12px; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .foot { flex-direction: column; align-items: stretch; }
      .action { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="quiz-card" role="region" aria-live="polite">
      <header>
        <div class="logo">üê±</div>
        <div>
          <h1>Kukyquiz</h1>
          <div id="loadmsg"><span class="spinner"></span> Cargando preguntas‚Ä¶</div>
        </div>
      </header>
      <div class="bar"><div id="progress"></div></div>
      <div class="qbox" id="qbox"></div>
      <div class="foot">
        <div class="pill" id="status"></div>
        <div class="action">
          <button class="pill" id="resetBtn" type="button">Reiniciar</button>
          <button class="cta" id="nextBtn" type="button" disabled>Siguiente ‚ñ∏</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (async function () {
      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
      const loadmsg = $('#loadmsg');
      const params = new URLSearchParams(location.search);
      const dataParam = params.get('data');

      if (!dataParam) {
        loadmsg.textContent = '‚ùå Falta ?data=... en la URL';
        return;
      }

      // Resuelve la URL correctamente
      function resolveDataURL(p) {
        if (/^https?:\/\//i.test(p)) return p;
        const baseDir = location.pathname.replace(/[^/]*$/, '');
        if (p.startsWith('/')) {
          p = p.replace(/^\/+/, '');
          return new URL(baseDir + p, location.origin).href;
        }
        return new URL(p, location.href).href;
      }

      // Timeout para evitar carga infinita
      function fetchWithTimeout(url, timeout = 10000) {
        return Promise.race([
          fetch(url, { cache: 'no-store' }),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
        ]);
      }

      async function loadQuestions() {
        const url = resolveDataURL(dataParam);
        loadmsg.textContent = '';
        loadmsg.insertAdjacentHTML('beforeend', '<span class="spinner"></span> Cargando desde servidor‚Ä¶');

        try {
          const res = await fetchWithTimeout(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          loadmsg.innerHTML = '‚úÖ Preguntas cargadas. ¬°Listo para jugar!';
          setTimeout(() => loadmsg.style.opacity = 0, 1000); // Fade out
          return normalize(json);
        } catch (err) {
          console.error('Error al cargar:', err);
          loadmsg.innerHTML = `‚ùå No se pudieron cargar las preguntas.<br><small>Verifica la URL o tu conexi√≥n.</small>`;
          loadmsg.style.color = 'var(--danger)';
          throw err;
        }
      }

      function normalize(data) {
        if (Array.isArray(data)) return { shuffle: true, questions: data };
        if (data && Array.isArray(data.questions)) return data;
        throw new Error('Formato JSON inv√°lido');
      }

      try {
        const data = await loadQuestions();
        let questions = data.shuffle ? shuffle(data.questions) : data.questions;
        let state = { idx: 0, score: 0, answered: false, history: [], finished: false };

        const qbox = $('#qbox');
        const nextBtn = $('#nextBtn');
        const resetBtn = $('#resetBtn');
        const progressEl = $('#progress');
        const statusEl = $('#status');

        resetBtn.addEventListener('click', resetQuiz);

        function resetQuiz() {
          state = { idx: 0, score: 0, answered: false, history: [], finished: false };
          questions = data.shuffle ? shuffle(data.questions) : data.questions;
          render();
        }

        nextBtn.addEventListener('click', () => {
          if (state.finished) {
            resetQuiz();
          } else if (state.idx < questions.length - 1) {
            state.idx++;
            state.answered = false;
            render();
          } else {
            showResult();
          }
        });

        function render() {
          const q = questions[state.idx];
          const total = questions.length;
          statusEl.textContent = `Pregunta ${state.idx + 1} de ${total}`;
          progressEl.style.width = `${(state.idx / total) * 100}%`;
          nextBtn.disabled = true;

          const shuffledIndices = shuffle([...Array(q.choices.length).keys()]);
          const choices = shuffledIndices.map(i => q.choices[i]);
          const answerIndex = shuffledIndices.indexOf(q.answer);

          qbox.innerHTML = `
            <div class="q">${escapeHtml(q.text)}</div>
            <div class="choices">
              ${choices.map((choice, i) => `
                <button class="btn" data-i="${i}">${escapeHtml(choice)}</button>
              `).join('')}
            </div>
          `;

          $$('.btn', qbox).forEach(btn => {
            btn.addEventListener('click', e => onPick(e, choices, answerIndex, q));
          });
        }

        function onPick(e, choices, answerIndex, q) {
          if (state.answered) return;
          const btn = e.currentTarget;
          const picked = Number(btn.dataset.i);
          state.answered = true;

          $$('.btn', qbox).forEach((b, i) => {
            b.disabled = true;
            if (i === answerIndex) b.classList.add('correct');
          });

          if (picked !== answerIndex) {
            btn.classList.add('wrong');
          } else {
            state.score++;
          }

          state.history[state.idx] = {
            pickedText: choices[picked],
            correctText: q.choices[q.answer]
          };

          nextBtn.textContent = state.idx === questions.length - 1 ? 'Ver resultado' : 'Siguiente ‚ñ∏';
          nextBtn.disabled = false;

          if (q.explain) {
            const exp = document.createElement('div');
            exp.className = 'muted';
            exp.style.marginTop = '6px';
            exp.textContent = "üí° " + q.explain;
            qbox.appendChild(exp);
          }

          progressEl.style.width = `${((state.idx + 1) / questions.length) * 100}%`;
        }

        function showResult() {
          state.finished = true;
          const total = questions.length;
          const pct = Math.round((state.score / total) * 100);
          const emoji = pct === 100 ? 'üèÜ' : pct >= 80 ? 'üéâ' : pct >= 60 ? '‚úÖ' : 'üìö';

          const review = questions.map((q, i) => {
            const h = state.history[i];
            const ok = h && h.pickedText === h.correctText;
            const pickedLabel = h ? h.pickedText : "‚Äî";
            return `
              <details>
                <summary>
                  ${ok ? '‚úîÔ∏è' : '‚úñÔ∏è'} ${escapeHtml(q.text)}
                  <span class="tag">Tu: ${escapeHtml(pickedLabel)}</span>
                  <span class="tag">Correcta: ${escapeHtml(q.choices[q.answer])}</span>
                </summary>
                <div class="muted">${escapeHtml(q.explain || 'Sin explicaci√≥n')}</div>
              </details>
            `;
          }).join('');

          qbox.innerHTML = `
            <div class="result">
              <div class="score">${emoji} ${state.score}/${total} ¬∑ ${pct}%</div>
              <h2>Resultado</h2>
            </div>
            <div class="review">${review}</div>
          `;
          statusEl.textContent = `Completado ¬∑ ${state.score}/${total}`;
          nextBtn.textContent = 'Repetir';
          nextBtn.disabled = false;
        }

        function shuffle(arr) {
          return [...arr].sort(() => Math.random() - 0.5);
        }

        function escapeHtml(str) {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }

        render();

      } catch (err) {
        console.warn('Quiz no cargado:', err.message);
      }
    })();
  </script>
</body>
</html>
