<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura Matem√°tica de Kuky</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #2e261f;
            --card: #3a3229;
            --muted: #b8a99a;
            --text: #f2e9df;
            --primary: #22c55e;
            --primary-ink: #052e16;
            --danger: #ef4444;
            --warning: #fbbf24;
            --ring: #4a3e33;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            text-align: center;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: var(--primary);
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        h2 {
            color: var(--warning);
        }

        #login {
            background: var(--card);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px var(--ring);
            width: 350px;
        }
        #game {
            display: none;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 6px 12px var(--ring);
            width: 400px;
        }
        #player-info {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: var(--text);
        }
        #problem {
            font-size: 2.5em;
            margin: 20px 0;
            color: var(--primary);
            animation: slideIn 0.5s ease-in-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .option-btn {
            background-color: var(--muted);
            color: var(--primary-ink);
            font-size: 1.5em;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            flex: 1 1 40%;
            min-width: 100px;
        }
        .option-btn:hover {
            background-color: var(--primary);
            color: var(--text);
        }
        button {
            background-color: var(--primary);
            color: var(--primary-ink);
            font-size: 1.2em;
            padding: 8px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px auto;
        }
        button:hover {
            background-color: var(--warning);
            color: var(--primary-ink);
        }
        #clear-all-btn {
            background-color: var(--muted);
            color: var(--ring);
            font-size: 0.9em;
            padding: 8px 15px;
        }
        #clear-all-btn:hover {
            background-color: var(--warning);
        }
        #feedback {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 10px;
            border-radius: 10px;
            animation: fadeIn 0.5s;
            position: relative;
            z-index: 2;
        }
        #feedback.correct {
            background-color: var(--primary);
            color: var(--primary-ink);
        }
        #feedback.incorrect {
            background-color: var(--danger);
            color: var(--text);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #progress {
            margin: 20px 0;
            font-size: 1em;
            color: var(--muted);
            position: relative;
        }
        #progress-text {
            margin-bottom: 10px;
        }
        #progress-bar {
            width: 100%;
            background: var(--muted);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        #progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }
        #progress-fill.pulse {
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .emoji {
            font-size: 1.5em;
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        #stars {
            color: var(--warning);
            font-size: 1.2em;
        }
        #operation-select, #level-select {
            margin-bottom: 15px;
        }
        #operation {
            font-size: 1.5em;
            padding: 15px;
            margin: 10px auto;
            border-radius: 15px;
            box-shadow: 0 3px 6px var(--ring);
            background-color: var(--muted);
            color: var(--primary-ink);
            border: 1px solid var(--ring);
            width: 250px;
            text-align: center;
            display: block;
        }
        #operation:focus, #operation:active {
            background-color: var(--warning);
            color: var(--ring);
            transform: scale(1.05);
            box-shadow: 0 5px 10px var(--ring);
        }
        select, input {
            font-size: 1.2em;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            background: var(--muted);
            color: var(--primary-ink);
            border: 1px solid var(--ring);
        }
        #timer {
            font-size: 1em;
            color: var(--danger);
            margin-top: 10px;
        }
        #leaderboard {
            margin-top: 20px;
            font-size: 1em;
            color: var(--text);
        }
        #leaderboard ul {
            list-style: none;
            padding: 0;
        }
        #leaderboard li {
            margin: 5px 0;
        }
        #users-list {
            margin-top: 20px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 5px;
            background: var(--muted);
            border-radius: 5px;
        }
        .user-item span {
            color: var(--primary-ink);
        }
        .user-item .actions {
    display: flex;
}
        .user-item button {
            font-size: 1em;
            padding: 5px 10px;
            margin: 0 5px;
        }
        .delete-btn {
            background-color: var(--danger);
        }
        .delete-btn:hover {
            background-color: var(--warning);
        }
    </style>
</head>
<body>
    <h1>üò∫ Mates con Kuky üåü</h1>
    <div id="login">
        <div id="new-player">
            <p>Nuevo Jugador:</p>
            <input type="text" id="new-username" placeholder="Ingresa tu nombre" style="width: 200px;">
            <button onclick="registerNewPlayer()">Registrar üöÄ</button>
        </div>
        <div id="users-list">
            <h2>Jugadores Registrados</h2>
        </div>
        <div id="operation-select" style="display: none;">
            <label>Elige el tipo de preguntas:</label><br>
            <select id="operation" onchange="selectOperation(this.value)">
                <option value="sum">‚ûï Suma</option>
                <option value="subtract">‚ûñ Resta</option>
                <option value="multiply">‚úñÔ∏è Multiplicaci√≥n</option>
                <option value="divide">‚ûó Divisi√≥n</option>
                <option value="mixed">üé≤ Mixta</option>
            </select>
        </div>
        <div id="level-select" style="display: none;">
            <label>Elige nivel inicial: </label>
            <select id="startLevel">
                <option value="1">1 (F√°cil) üå±</option>
                <option value="2">2 üåº</option>
                <option value="3">3 üåü</option>
                <option value="4">4 üèÜ</option>
                <option value="5">5 (Avanzado) üöÄ</option>
            </select>
        </div>
        <button id="start-btn" onclick="startGame()" style="display: none;">¬°Empezar! üöÄ</button>
        <button id="clear-all-btn" onclick="clearAllStorage()">Limpiar Todos los Registros üóëÔ∏è</button>
        <div id="leaderboard">
            <h2>Mejores Puntajes ‚≠ê</h2>
            <ul id="leaderboard-list"></ul>
        </div>
    </div>
    <div id="game">
        <div id="player-info"></div>
        <div id="problem"></div>
        <div class="options" id="options"></div>
        <div id="progress">
            <div id="progress-text"></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div id="feedback"></div>
        </div>
        <div id="stars">Estrellas: 0 ‚≠ê</div>
        <div id="timer">Tiempo restante: 10:00 ‚è∞</div>
        <button onclick="finishGame()">Finalizar Actividad üèÅ</button>
        <button onclick="resetGame()">Salir ‚ùå</button>
    </div>

    <script>
        let currentLevel = 1;
        let correctCount = 0;
        let errorCount = 0;
        let stars = 0;
        let currentOperation = 'sum';
        let timerInterval;
        let timeLeft = 600; // 10 minutos
        let username = '';
        let leaderboard = JSON.parse(localStorage.getItem('mathLeaderboard')) || [];
        let selectedForGame = false;

        const levels = {
            sum: [
                { min: 1, max: 5 },
                { min: 1, max: 10 },
                { min: 1, max: 20 },
                { min: 10, max: 50 },
                { min: 1, max: 100 }
            ],
            subtract: [
                { min: 1, max: 5 },
                { min: 1, max: 10 },
                { min: 1, max: 20 },
                { min: 10, max: 50 },
                { min: 1, max: 100 }
            ],
            multiply: [
                { min: 1, max: 5 },
                { min: 1, max: 10 },
                { min: 2, max: 12 },
                { min: 5, max: 15 },
                { min: 1, max: 20 }
            ],
            divide: [
                { min: 1, max: 5, divisorMin: 1, divisorMax: 5 },
                { min: 1, max: 10, divisorMin: 1, divisorMax: 5 },
                { min: 1, max: 20, divisorMin: 2, divisorMax: 10 },
                { min: 10, max: 50, divisorMin: 2, divisorMax: 10 },
                { min: 1, max: 100, divisorMin: 2, divisorMax: 20 }
            ],
            mixed: [
                { numTerms: 2, max: 5 },  // Level 1: e.g., 3 + 4
                { numTerms: 2, max: 10 }, // Level 2: e.g., 7 - 2
                { numTerms: 3, max: 10 }, // Level 3: e.g., 8 + 3 - 2
                { numTerms: 3, max: 20, hasMultOrDiv: true, maxFactor: 12 }, // Level 4
                { numTerms: 4, max: 20, hasMultOrDiv: true, maxFactor: 12 }  // Level 5
            ]
        };

        function getUniqueUsers() {
            const users = new Set();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('mathProgress_')) {
                    const user = key.split('_')[1];
                    users.add(user);
                }
            }
            leaderboard.forEach(entry => users.add(entry.name));
            return Array.from(users);
        }

        function updateUsersList() {
            const usersList = document.getElementById('users-list');
            if (!usersList) return;
            usersList.innerHTML = '<h2>üë• Jugadores Registrados</h2>';
            const users = getUniqueUsers();
            if (users.length === 0) {
                usersList.innerHTML += '<p>No hay jugadores registrados.</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            users.forEach(user => {
                const li = document.createElement('li');
                li.classList.add('user-item');
                li.innerHTML = `<span>${user}</span>
                    <div class="actions"><button onclick="selectUser('${user}')">Elegir ‚úÖ</button>
                    <button class="delete-btn" onclick="deleteUser('${user}')">Borrar ‚ùå</button></div>`;
                ul.appendChild(li);
            });
            usersList.appendChild(ul);
        }

        function selectUser(user) {
            username = user;
            selectedForGame = true;
            document.getElementById('operation-select').style.display = 'block';
            document.getElementById('level-select').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
            const newUsernameInput = document.getElementById('new-username');
            if (newUsernameInput) newUsernameInput.value = '';
        }

        function selectOperation(op) {
            currentOperation = op;
            document.getElementById('level-select').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
        }

        function registerNewPlayer() {
            const newUser = document.getElementById('new-username').value.trim();
            if (!newUser) return alert('¬°Ingresa un nombre! üòä');
            const users = getUniqueUsers();
            if (users.includes(newUser)) return alert('¬°Este nombre ya existe! Elige otro. üòä');
            username = newUser;
            selectedForGame = true;
            document.getElementById('operation-select').style.display = 'block';
            document.getElementById('level-select').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
        }

        function deleteUser(user) {
            if (confirm(`¬øEst√°s seguro de eliminar a ${user}? Esto borrar√° su progreso y puntajes.`)) {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`mathProgress_${user}_`)) {
                        localStorage.removeItem(key);
                    }
                }
                leaderboard = leaderboard.filter(entry => entry.name !== user);
                localStorage.setItem('mathLeaderboard', JSON.stringify(leaderboard));
                updateLeaderboard();
                updateUsersList();
                alert(`${user} ha sido eliminado.`);
            }
        }

        function clearAllStorage() {
            if (confirm('¬øEst√°s seguro de limpiar todos los registros? Esto borrar√° todo.')) {
                localStorage.clear();
                leaderboard = [];
                updateLeaderboard();
                updateUsersList();
                alert('Todos los registros limpiados. ¬°Empieza de nuevo! üòä');
            }
        }

        function loadProgress() {
            const userKey = `mathProgress_${username}_${currentOperation}`;
            const saved = localStorage.getItem(userKey);
            if (saved) {
                const data = JSON.parse(saved);
                currentLevel = data.level || 1;
                stars = data.stars || 0;
            } else {
                const startLevelSelect = document.getElementById('startLevel');
                currentLevel = startLevelSelect ? parseInt(startLevelSelect.value) : 1;
                stars = 0;
            }
        }

        function saveProgress() {
            const userKey = `mathProgress_${username}_${currentOperation}`;
            localStorage.setItem(userKey, JSON.stringify({
                level: currentLevel,
                stars: stars
            }));
        }

        function updateLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            if (!list) return;
            list.innerHTML = '';
            leaderboard.sort((a, b) => b.stars - a.stars);
            leaderboard.slice(0, 5).forEach(entry => {
                const li = document.createElement('li');
                li.textContent = `${entry.name} - ${entry.operation.charAt(0).toUpperCase() + entry.operation.slice(1)} - Nivel ${entry.level}: ‚≠ê ${entry.stars}`;
                list.appendChild(li);
            });
        }

        function startGame() {
            if (!selectedForGame) return alert('¬°Selecciona o registra un jugador primero! üòä');
            currentOperation = currentOperation || document.getElementById('operation').value;
            loadProgress();
            document.getElementById('login').style.display = 'none';
            requestAnimationFrame(() => {
                document.getElementById('game').style.display = 'block';
                updatePlayerInfo();
                generateProblem();
                updateProgress();
                updateStars();
                timeLeft = 600;
                startTimer();
            });
        }

        function updatePlayerInfo() {
            const playerInfo = document.getElementById('player-info');
            if (playerInfo) {
                playerInfo.innerText = `${username}: ${currentOperation.charAt(0).toUpperCase() + currentOperation.slice(1)} - Nivel: [${currentLevel}]`;
            }
        }

        function generateProblem() {
            const problemDiv = document.getElementById('problem');
            const optionsDiv = document.getElementById('options');
            if (!problemDiv || !optionsDiv) return;

            let problemText, correctAnswer;
            const levelData = levels[currentOperation][currentLevel - 1];

            if (currentOperation === 'mixed') {
                const numTerms = levelData.numTerms || 2;
                const max = levelData.max;
                const maxFactor = levelData.maxFactor || max;
                let exprParts = [];
                let numbers = [];
                let operators = [];

                if (numTerms === 2) {
                    // Levels 1-2: Two numbers with + or -
                    numbers.push(Math.floor(Math.random() * max) + 1);
                    numbers.push(Math.floor(Math.random() * max) + 1);
                    operators.push(['+', '-'][Math.floor(Math.random() * 2)]);
                    exprParts = [numbers[0], operators[0], numbers[1]];
                    correctAnswer = operators[0] === '+' ? numbers[0] + numbers[1] : numbers[0] - numbers[1];
                } else {
                    // Levels 3-5: Three numbers
                    if (levelData.hasMultOrDiv) {
                        // Levels 4-5: One √ó or √∑, one + or -
                        const complexOp = ['√ó', '√∑'][Math.floor(Math.random() * 2)];
                        const simpleOp = ['+', '-'][Math.floor(Math.random() * 2)];
                        operators.push(complexOp, simpleOp);

                        if (complexOp === '√∑') {
                            // CORRECCI√ìN: L√≥gica de divisi√≥n mejorada
                            let divisor;
                            let maxQuotient;
                            let attempts = 0;
                            const maxAttempts = 10;
                            
                            // Buscar un divisor v√°lido
                            do {
                                divisor = Math.floor(Math.random() * maxFactor) + 1;
                                maxQuotient = Math.floor(max / divisor);
                                attempts++;
                                if (attempts > maxAttempts) break;
                            } while (maxQuotient < 2); // Necesitamos cociente >= 2 para que dividendo > divisor
                            
                            // Si no encontramos divisor v√°lido, usar uno por defecto
                            if (maxQuotient < 2) {
                                divisor = 1;
                                maxQuotient = max;
                            }
                            
                            // Elegir cociente entre 2 y maxQuotient
                            const minQuotient = 2;
                            const quotient = Math.floor(Math.random() * (maxQuotient - minQuotient + 1)) + minQuotient;
                            const dividend = divisor * quotient;
                            
                            // Asegurar que dividend est√° dentro del rango
                            if (dividend > max) {
                                const newMaxQuotient = Math.floor(max / divisor);
                                const newQuotient = Math.floor(Math.random() * (newMaxQuotient - minQuotient + 1)) + minQuotient;
                                numbers[1] = divisor * newQuotient;
                            } else {
                                numbers[1] = dividend;
                            }
                            numbers[2] = divisor;
                            
                            // Primer n√∫mero dentro del rango
                            numbers[0] = Math.floor(Math.random() * max) + 1;
                            
                            // Estructura aleatoria
                            const structure = Math.random() < 0.5 ? 'complexFirst' : 'complexLast';
                            if (structure === 'complexFirst') {
                                exprParts = [`(${numbers[1]} ${complexOp} ${numbers[2]})`, simpleOp, numbers[0]];
                                const temp = numbers[1] / numbers[2];
                                correctAnswer = simpleOp === '+' ? temp + numbers[0] : temp - numbers[0];
                            } else {
                                exprParts = [numbers[0], simpleOp, `(${numbers[1]} ${complexOp} ${numbers[2]})`];
                                const temp = numbers[1] / numbers[2];
                                correctAnswer = simpleOp === '+' ? numbers[0] + temp : numbers[0] - temp;
                            }
                        } else {
                            // Multiplicaci√≥n: ambos factores 1-12
                            numbers[0] = Math.floor(Math.random() * max) + 1; // Primer n√∫mero
                            numbers[1] = Math.floor(Math.random() * maxFactor) + 1; // Primer factor 1-12
                            numbers[2] = Math.floor(Math.random() * maxFactor) + 1; // Segundo factor 1-12
                            
                            // Estructura aleatoria
                            const structure = Math.random() < 0.5 ? 'complexFirst' : 'complexLast';
                            if (structure === 'complexFirst') {
                                exprParts = [`(${numbers[0]} ${complexOp} ${numbers[1]})`, simpleOp, numbers[2]];
                                const temp = numbers[0] * numbers[1];
                                correctAnswer = simpleOp === '+' ? temp + numbers[2] : temp - numbers[2];
                            } else {
                                exprParts = [numbers[0], simpleOp, `(${numbers[1]} ${complexOp} ${numbers[2]})`];
                                const temp = numbers[1] * numbers[2];
                                correctAnswer = simpleOp === '+' ? numbers[0] + temp : numbers[0] - temp;
                            }
                        }
                    } else {
                        // Level 3: Three numbers with + or -
                        numbers.push(Math.floor(Math.random() * max) + 1);
                        numbers.push(Math.floor(Math.random() * max) + 1);
                        numbers.push(Math.floor(Math.random() * max) + 1);
                        operators.push(['+', '-'][Math.floor(Math.random() * 2)]);
                        operators.push(['+', '-'][Math.floor(Math.random() * 2)]);
                        exprParts = [numbers[0], operators[0], numbers[1], operators[1], numbers[2]];
                        let temp = operators[0] === '+' ? numbers[0] + numbers[1] : numbers[0] - numbers[1];
                        correctAnswer = operators[1] === '+' ? temp + numbers[2] : temp - numbers[2];
                    }
                }

                problemText = exprParts.join(' ') + ' = ';
            } else {
                let a = Math.floor(Math.random() * (levelData.max - levelData.min + 1)) + levelData.min;
                let b;
                if (currentOperation === 'divide') {
                    b = Math.floor(Math.random() * (levelData.divisorMax - levelData.divisorMin + 1)) + levelData.divisorMin;
                    a = b * (Math.floor(Math.random() * Math.floor(levelData.max / b)) + 1);
                } else {
                    b = Math.floor(Math.random() * (levelData.max - levelData.min + 1)) + levelData.min;
                    if (currentOperation === 'subtract' && b > a) [a, b] = [b, a];
                }
                const opSymbol = currentOperation === 'sum' ? '+' : currentOperation === 'subtract' ? '-' : currentOperation === 'multiply' ? '√ó' : '√∑';
                problemText = `${a} ${opSymbol} ${b} = `;
                correctAnswer = currentOperation === 'sum' ? a + b : currentOperation === 'subtract' ? a - b : currentOperation === 'multiply' ? a * b : a / b;
            }

            problemDiv.innerText = problemText;
            window.correctAnswer = correctAnswer;

            optionsDiv.innerHTML = '';
            let options = [correctAnswer];
            let possibleOffsets = Array.from({length: 21}, (_, i) => i - 10).filter(offset => offset !== 0);
            possibleOffsets.sort(() => Math.random() - 0.5);
            for (let offset of possibleOffsets) {
                let wrong = correctAnswer + offset;
                if (wrong >= 0 && !options.includes(wrong)) {
                    options.push(wrong);
                    if (options.length === 4) break;
                }
            }
            if (options.length < 4) {
                for (let i = 11; options.length < 4; i++) {
                    let wrongPos = correctAnswer + i;
                    let wrongNeg = correctAnswer - i;
                    if (wrongPos >= 0 && !options.includes(wrongPos)) options.push(wrongPos);
                    if (options.length === 4) break;
                    if (wrongNeg >= 0 && !options.includes(wrongNeg)) options.push(wrongNeg);
                    if (options.length === 4) break;
                }
            }
            options.sort(() => Math.random() - 0.5);
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.classList.add('option-btn');
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(opt, btn);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(userAnswer, button) {
            const feedback = document.getElementById('feedback');
            if (!feedback) return;
            if (userAnswer === window.correctAnswer) {
                feedback.innerHTML = '¬°Correcto! üòç <span class="emoji">üéâ</span>';
                feedback.className = 'correct';
                correctCount++;
                stars += 10;
                if (correctCount >= 10) {
                    currentLevel++;
                    correctCount = 0;
                    errorCount = 0;
                    feedback.innerHTML += '<br>¬°Subes de nivel! üèÜ';
                    if (currentLevel > 5) currentLevel = 5;
                    updatePlayerInfo();
                }
            } else {
                feedback.innerHTML = `¬°Oops! La respuesta es ${window.correctAnswer}. üòî <span class="emoji">üí™</span>`;
                feedback.className = 'incorrect';
                errorCount++;
                if (errorCount >= 3) {
                    currentLevel = Math.max(1, currentLevel - 1);
                    correctCount = 0;
                    errorCount = 0;
                    feedback.innerHTML += '<br>Vuelve al nivel anterior para reforzar. üìö';
                    updatePlayerInfo();
                }
            }
            saveProgress();
            updateProgress();
            updateStars();
            setTimeout(() => {
                if (feedback) {
                    feedback.innerHTML = '';
                    feedback.className = '';
                }
                generateProblem();
            }, 2000);
        }

        function updateProgress() {
            const progressText = document.getElementById('progress-text');
            const progressFill = document.getElementById('progress-fill');
            if (progressText && progressFill) {
                progressText.innerHTML = `Aciertos: ${correctCount}/10 ‚úÖ<br>Errores: ${errorCount}/3 ‚ùå`;
                progressFill.style.width = `${(correctCount / 10) * 100}%`;
                progressFill.classList.add('pulse');
                setTimeout(() => progressFill.classList.remove('pulse'), 500);
            }
        }

        function updateStars() {
            const starsDiv = document.getElementById('stars');
            if (starsDiv) {
                starsDiv.innerHTML = `Estrellas: ${stars} ‚≠ê`;
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const timerDiv = document.getElementById('timer');
                if (timerDiv) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDiv.innerText = `Tiempo restante: ${minutes}:${seconds < 10 ? '0' : ''}${seconds} ‚è∞`;
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('¬°Tiempo terminado! Buen trabajo. üòä');
                    finishGame();
                }
            }, 1000);
        }

        function finishGame() {
            clearInterval(timerInterval);
            leaderboard = leaderboard.filter(entry => !(entry.name === username && entry.operation === currentOperation));
            leaderboard.push({ name: username, operation: currentOperation, stars, level: currentLevel });
            localStorage.setItem('mathLeaderboard', JSON.stringify(leaderboard));
            resetGame();
        }

        function resetGame() {
            saveProgress();
            timeLeft = 600;
            clearInterval(timerInterval);
            location.reload();
        }

        // Initialize
        updateUsersList();
        updateLeaderboard();
    </script>
</body>
</html>
