<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura Matem√°tica de Kuky</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #2e261f;
            --card: #3a3229;
            --muted: #b8a99a;
            --text: #f2e9df;
            --primary: #22c55e; /* Green */
            --primary-light: #4ade80;
            --primary-ink: #052e16;
            --danger: #ef4444; /* Red */
            --warning: #fbbf24; /* Yellow */
            --ring: #4a3e33;
            --info: #3b82f6; /* Blue */
        }

        /* Transiciones suaves entre vistas */
        .view {
            display: none;
            width: 90%;
            max-width: 450px;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            animation: fadeIn 0.5s ease-out;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            text-align: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        h1, h2, h3 {
            margin: 0 0 15px 0;
            font-weight: 900;
        }
        
        h1 {
            color: var(--primary);
            font-size: clamp(2em, 8vw, 2.8em);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h2 { color: var(--warning); }
        
        /* Mascota Kuky */
        #kuky-mascot {
            font-size: clamp(2.5em, 10vw, 3em);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Estilos para botones e inputs m√°s atractivos */
        button, .btn {
            background-color: var(--primary);
            color: var(--primary-ink);
            font-size: 1.2em;
            font-weight: 700;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        button:hover, .btn:hover {
            transform: scale(1.05);
            background-color: var(--primary-light);
        }

        .btn-danger { background-color: var(--danger); color: var(--text); }
        .btn-danger:hover { background-color: #f87171; }
        .btn-secondary { background-color: var(--muted); color: var(--ring); }
        .btn-secondary:hover { background-color: #d6c6b9; }

        input, select {
            font-family: 'Nunito', sans-serif;
            font-size: 1.1em;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--ring);
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Lista de usuarios redise√±ada */
        #users-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .user-item:hover { background-color: var(--ring); transform: scale(1.02); }
        .user-item span { font-size: 1.2em; font-weight: 700; }
        .user-item .delete-btn { font-size: 0.8em; padding: 5px 8px; width: auto;}

        /* Estilos del juego */
        #player-info {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--warning);
            font-weight: 700;
        }
        #problem {
            font-size: clamp(2.5em, 12vw, 3.5em);
            font-weight: 900;
            margin: 20px 0;
            color: var(--text);
            animation: popIn 0.3s;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .options, #level-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }
        .option-btn, .level-btn {
            background-color: var(--info);
            color: var(--text);
            font-size: 1.8em;
            font-weight: 700;
            padding: 15px;
        }
        .option-btn:hover, .level-btn:hover { background-color: #60a5fa; }
        
        /* Animaciones para respuestas */
        .option-btn.correct { animation: correct-pulse 0.5s; background-color: var(--primary); }
        .option-btn.incorrect { animation: shake 0.5s; background-color: var(--danger); }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        @keyframes correct-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        #progress-bar {
            width: 100%;
            background: var(--bg);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 10px;
        }
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0%;
            transition: width 0.5s ease;
        }

        #feedback { font-size: 1.5em; margin-top: 20px; height: 30px; font-weight: 700; }
        #stats-bar {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
            font-size: 1.2em;
        }
        #summary-stats { list-style: none; padding: 0; font-size: 1.3em; text-align: left;}
        #summary-stats li { margin-bottom: 10px; }

        /* Modal de confirmaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--card);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #modal-message {
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        .modal-actions {
            display: flex;
            gap: 15px;
        }
    </style>
</head>
<body>

    <h1><span id="kuky-mascot">üò∫</span> Mates con Kuky</h1>

    <!-- VISTA 1: LOGIN -->
    <div id="login-view" class="view active">
        <h2>Elige tu Perfil</h2>
        <div id="users-list"></div>
        <input type="text" id="new-username" placeholder="... o crea un perfil nuevo" maxlength="15">
        <button onclick="KukyApp.register()">Crear y Jugar üöÄ</button>
        <button id="clear-all-btn" class="btn-secondary" onclick="KukyApp.confirmClearAllData()" style="margin-top: 20px; font-size: 0.8em;">Limpiar Datos üóëÔ∏è</button>
    </div>

    <!-- VISTA 2: DASHBOARD / SELECCI√ìN DE JUEGO -->
    <div id="dashboard-view" class="view">
        <h2 id="welcome-message"></h2>
        <h3>¬øQu√© quieres practicar hoy?</h3>
        <select id="operation">
            <option value="sum">‚ûï Suma</option>
            <option value="subtract">‚ûñ Resta</option>
            <option value="multiply">‚úñÔ∏è Multiplicaci√≥n</option>
            <option value="divide">‚ûó Divisi√≥n</option>
            <option value="mixed">üé≤ Mixto</option>
        </select>
        <button onclick="KukyApp.selectOperation()">Elegir Nivel</button>
        <button onclick="KukyApp.reset()" class="btn-secondary" style="margin-top: 15px;">Cambiar de Perfil</button>
    </div>
    
    <!-- VISTA 2.5: SELECCI√ìN DE NIVEL -->
    <div id="level-select-view" class="view">
        <h2>Elige un Nivel Inicial</h2>
        <div id="level-options">
            <button class="level-btn" onclick="KukyApp.startGame(1)">1 üå±</button>
            <button class="level-btn" onclick="KukyApp.startGame(2)">2 üåº</button>
            <button class="level-btn" onclick="KukyApp.startGame(3)">3 üåü</button>
            <button class="level-btn" onclick="KukyApp.startGame(4)">4 üèÜ</button>
        </div>
        <button class="level-btn" style="grid-column: 1 / -1; margin-top: 15px;" onclick="KukyApp.startGame(5)">5 üöÄ</button>
        <button onclick="KukyApp.returnToDashboard(true)" class="btn-secondary" style="margin-top: 15px;">Volver</button>
    </div>

    <!-- VISTA 3: JUEGO -->
    <div id="game-view" class="view">
        <div id="player-info"></div>
        <div id="problem"></div>
        <div class="options" id="options"></div>
        <div id="feedback"></div>
        <div id="progress-text" style="margin-top: 15px;"></div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="stats-bar">
            <div id="stars">‚≠ê 0</div>
            <div id="timer">‚è∞ 10:00</div>
        </div>
        <button onclick="KukyApp.finishGame(false)" class="btn-danger" style="margin-top: 20px;">Terminar üèÅ</button>
    </div>

    <!-- VISTA 4: RESUMEN -->
    <div id="summary-view" class="view">
        <h2>¬°Buen Trabajo!</h2>
        <ul id="summary-stats"></ul>
        <div id="summary-kuky" style="font-size: 4em; margin: 15px;">üéâ</div>
        <button onclick="KukyApp.returnToDashboard(false)">Seguir Practicando</button>
    </div>

    <!-- MODAL DE CONFIRMACI√ìN -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="btn-danger">Confirmar</button>
                <button id="modal-cancel-btn" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Efectos de sonido (URLs externas, para un proyecto local se deber√≠an descargar) -->
    <audio id="sfx-correct" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_interface_button_select_positive_024.mp3" preload="auto"></audio>
    <audio id="sfx-incorrect" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-four-hundred/com_sfx_error_03.mp3" preload="auto"></audio>
    <audio id="sfx-level-up" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-little-robot-sound-factory/lrsf_sfx_and_stings_win_01.mp3" preload="auto"></audio>

    <script>
    // FULLSTACK MEJORA: M√≥dulo para simular llamadas a una API.
    const api = {
        getUsers: () => Promise.resolve(JSON.parse(localStorage.getItem('kuky_users')) || []),
        saveUser: (user) => {
            const users = JSON.parse(localStorage.getItem('kuky_users')) || [];
            if (!users.find(u => u.name === user.name)) {
                users.push(user);
                localStorage.setItem('kuky_users', JSON.stringify(users));
            }
            return Promise.resolve(user);
        },
        deleteUser: (username) => {
            let users = JSON.parse(localStorage.getItem('kuky_users')) || [];
            users = users.filter(u => u.name !== username);
            localStorage.setItem('kuky_users', JSON.stringify(users));
            return Promise.resolve();
        },
        saveProgress: (username, operation, progress) => {
            let users = JSON.parse(localStorage.getItem('kuky_users')) || [];
            const user = users.find(u => u.name === username);
            if (user) {
                if (!user.progress) user.progress = {};
                user.progress[operation] = progress;
                localStorage.setItem('kuky_users', JSON.stringify(users));
            }
            return Promise.resolve(progress);
        },
        clearAll: () => {
            localStorage.removeItem('kuky_users');
            return Promise.resolve();
        }
    };

    // L√ìGICA MEJORA: Todo el c√≥digo encapsulado en un objeto para evitar variables globales.
    const KukyApp = {
        state: {
            currentUser: null,
            currentOperation: 'sum',
            level: 1,
            correctCount: 0,
            errorCount: 0,
            stars: 0,
            timerInterval: null,
            timeLeft: 600,
            sessionStats: { correct: 0, incorrect: 0 }
        },

        init() {
            this.ui.updateUsersList();
            document.getElementById('new-username').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.register();
            });
            document.getElementById('modal-cancel-btn').onclick = () => this.ui.hideModal();
        },

        ui: {
            showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
            },

            async updateUsersList() {
                const users = await api.getUsers();
                const listEl = document.getElementById('users-list');
                listEl.innerHTML = '';
                if (users.length === 0) {
                    listEl.innerHTML = '<p style="margin: 10px 0;">¬°S√© el primer jugador! üëá</p>';
                    return;
                }
                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    item.innerHTML = `
                        <span>${user.name}</span>
                        <button class="delete-btn btn-danger" onclick="event.stopPropagation(); KukyApp.confirmDeleteUser('${user.name}')">‚ùå</button>
                    `;
                    item.onclick = () => KukyApp.login(user.name);
                    listEl.appendChild(item);
                });
            },

            updatePlayerInfo() {
                const opText = {sum:'Suma',subtract:'Resta',multiply:'Multiplicaci√≥n',divide:'Divisi√≥n',mixed:'Mixto'}[KukyApp.state.currentOperation];
                document.getElementById('player-info').innerText = `${opText} - Nivel ${KukyApp.state.level}`;
            },
            
            updateGameStats() {
                document.getElementById('progress-text').innerHTML = `Aciertos: ${KukyApp.state.correctCount}/10 ‚úÖ | Errores: ${KukyApp.state.errorCount}/3 ‚ùå`;
                const progressFill = document.getElementById('progress-fill');
                progressFill.style.width = `${(KukyApp.state.correctCount / 10) * 100}%`;
                document.getElementById('stars').innerText = `‚≠ê ${KukyApp.state.stars}`;
            },

            updateTimer() {
                const minutes = Math.floor(KukyApp.state.timeLeft / 60);
                const seconds = KukyApp.state.timeLeft % 60;
                document.getElementById('timer').innerText = `‚è∞ ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            },

            showModal(message, onConfirm) {
                document.getElementById('modal-message').innerText = message;
                const modal = document.getElementById('confirmation-modal');
                modal.style.display = 'flex';
                
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.onclick = () => {
                    onConfirm();
                    this.hideModal();
                };
            },

            hideModal() {
                document.getElementById('confirmation-modal').style.display = 'none';
            }
        },
        
        async register() {
            const usernameInput = document.getElementById('new-username');
            const username = usernameInput.value.trim();
            if (!username) { 
                usernameInput.style.borderColor = 'var(--danger)';
                setTimeout(() => { usernameInput.style.borderColor = 'var(--ring)'; }, 1500);
                return; 
            }
            const users = await api.getUsers();
            if (users.some(u => u.name.toLowerCase() === username.toLowerCase())) {
                usernameInput.value = '';
                usernameInput.placeholder = '¬°Ese nombre ya existe!';
                usernameInput.style.borderColor = 'var(--danger)';
                setTimeout(() => { 
                    usernameInput.placeholder = '... o crea un perfil nuevo';
                    usernameInput.style.borderColor = 'var(--ring)'; 
                }, 2000);
                return;
            }
            const newUser = { name: username, progress: {} };
            await api.saveUser(newUser);
            this.login(username);
        },

        async login(username) {
            const users = await api.getUsers();
            this.state.currentUser = users.find(u => u.name === username);
            document.getElementById('welcome-message').innerText = `¬°Hola, ${this.state.currentUser.name}!`;
            this.ui.showView('dashboard-view');
        },
        
        confirmDeleteUser(username) {
            this.ui.showModal(`¬øSeguro que quieres borrar a ${username}? Se perder√° todo su progreso.`, async () => {
                await api.deleteUser(username);
                this.ui.updateUsersList();
            });
        },

        selectOperation() {
            this.state.currentOperation = document.getElementById('operation').value;
            const progress = this.state.currentUser.progress?.[this.state.currentOperation];
            // Si hay progreso, se omite la selecci√≥n de nivel y se carga el nivel guardado.
            if (progress && progress.level) {
                this.startGame(progress.level);
            } else {
                this.ui.showView('level-select-view');
            }
        },

        startGame(startLevel) {
            this.state.level = startLevel;
            const progress = this.state.currentUser.progress?.[this.state.currentOperation];
            this.state.stars = progress ? progress.stars : 0;
            
            this.state.correctCount = 0;
            this.state.errorCount = 0;
            this.state.sessionStats = { correct: 0, incorrect: 0 };
            
            this.ui.updatePlayerInfo();
            this.ui.updateGameStats();
            this.game.generateProblem();
            
            this.state.timeLeft = 600;
            this.ui.updateTimer();
            this.state.timerInterval = setInterval(() => {
                this.state.timeLeft--;
                this.ui.updateTimer();
                if (this.state.timeLeft <= 0) {
                    this.finishGame(true);
                }
            }, 1000);
            
            this.ui.showView('game-view');
        },

        game: {
            // L√ìGICA MEJORA: Dificultad ajustada y progresiva
            levels: {
                sum: [{min:1,max:5},{min:1,max:10},{min:10,max:50},{min:20,max:100},{min:50,max:200}],
                subtract: [{min:1,max:5},{min:1,max:10},{min:10,max:50},{min:20,max:100},{min:50,max:200}],
                multiply: [{min:1,max:5},{min:1,max:10},{min:2,max:12},{min:5,max:15},{min:10,max:20}],
                divide: [{dMax:5,qMax:10},{dMax:10,qMax:10},{dMax:12,qMax:12},{dMax:15,qMax:15},{dMax:20,qMax:20}],
                mixed: [{max:10,ops:['+','-']},{max:20,ops:['+','-']},{max:50,ops:['+','-']},{max:20,ops:['+','-','*','/']},{max:30,ops:['+','-','*','/']}]
            },
            
            generateProblem() {
                const op = KukyApp.state.currentOperation;
                const level = KukyApp.state.level;
                let problemText, correctAnswer;
                const levelData = this.levels[op][Math.min(level, 5) - 1];

                // L√ìGICA MEJORA: Problemas mixtos avanzados para Nivel 5
                if (op === 'mixed' && level === 5) {
                    const simpleOp = Math.random() < 0.5 ? '+' : '-';
                    const complexOp = Math.random() < 0.5 ? '√ó' : '√∑';
                    let part1, part2, part3, tempResult;

                    if (complexOp === '√ó') {
                        part1 = Math.floor(Math.random() * 10) + 2;
                        part2 = Math.floor(Math.random() * 10) + 2;
                        tempResult = part1 * part2;
                    } else { // '√∑'
                        part2 = Math.floor(Math.random() * 10) + 2;
                        tempResult = Math.floor(Math.random() * 10) + 2;
                        part1 = part2 * tempResult;
                    }
                    part3 = Math.floor(Math.random() * 20) + 1;

                    if (Math.random() < 0.5) { // (A op B) op C
                        problemText = `(${part1} ${complexOp} ${part2}) ${simpleOp} ${part3} =`;
                        correctAnswer = simpleOp === '+' ? tempResult + part3 : tempResult - part3;
                        if (correctAnswer < 0) { // Evitar negativos
                            problemText = `(${part1} ${complexOp} ${part2}) + ${part3} =`;
                            correctAnswer = tempResult + part3;
                        }
                    } else { // C op (A op B)
                        problemText = `${part3} ${simpleOp} (${part1} ${complexOp} ${part2}) =`;
                        correctAnswer = simpleOp === '+' ? part3 + tempResult : part3 - tempResult;
                         if (correctAnswer < 0) { // Evitar negativos
                            problemText = `${tempResult + part3} - (${part1} ${complexOp} ${part2}) =`;
                            correctAnswer = part3;
                        }
                    }

                } else if (op === 'mixed') {
                    const operators = levelData.ops;
                    const chosenOp = operators[Math.floor(Math.random() * operators.length)];
                    let n1 = Math.floor(Math.random() * levelData.max) + 1;
                    let n2 = Math.floor(Math.random() * levelData.max) + 1;
                    
                    switch (chosenOp) {
                        case '+': problemText = `${n1} + ${n2} =`; correctAnswer = n1 + n2; break;
                        case '-': if (n2 > n1) [n1, n2] = [n2, n1]; problemText = `${n1} - ${n2} =`; correctAnswer = n1 - n2; break;
                        case '*': n1 = Math.floor(Math.random() * 10) + 1; n2 = Math.floor(Math.random() * 10) + 1; problemText = `${n1} √ó ${n2} =`; correctAnswer = n1 * n2; break;
                        case '/': n2 = Math.floor(Math.random() * 10) + 2; n1 = n2 * (Math.floor(Math.random() * 10) + 1); problemText = `${n1} √∑ ${n2} =`; correctAnswer = n1 / n2; break;
                    }
                } else {
                    let a, b;
                    if (op === 'divide') {
                        b = Math.floor(Math.random() * (levelData.dMax - 2 + 1)) + 2; // Divisor
                        const q = Math.floor(Math.random() * (levelData.qMax - 1 + 1)) + 1; // Cociente
                        a = b * q; // Dividendo
                    } else {
                        a = Math.floor(Math.random() * (levelData.max - levelData.min + 1)) + levelData.min;
                        b = Math.floor(Math.random() * (levelData.max - levelData.min + 1)) + levelData.min;
                    }
                    if (op === 'subtract' && b > a) [a, b] = [b, a];
                    
                    const opSymbol = { sum: '+', subtract: '-', multiply: '√ó', divide: '√∑' }[op];
                    problemText = `${a} ${opSymbol} ${b} =`;
                    correctAnswer = { sum: a + b, subtract: a - b, multiply: a * b, divide: a / b }[op];
                }
                
                document.getElementById('problem').innerText = problemText;
                this.generateOptions(correctAnswer);
            },

            generateOptions(correctAnswer) {
                const optionsDiv = document.getElementById('options');
                optionsDiv.innerHTML = '';
                let options = new Set([correctAnswer]);
                while (options.size < 4) {
                    const offset = Math.floor(Math.random() * 10) + 1;
                    const wrongAnswer = Math.random() < 0.5 ? correctAnswer + offset : correctAnswer - offset;
                    if (wrongAnswer >= 0 && !options.has(wrongAnswer)) {
                        options.add(wrongAnswer);
                    }
                }
                const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
                shuffledOptions.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = opt;
                    btn.onclick = () => KukyApp.checkAnswer(opt, correctAnswer, btn);
                    optionsDiv.appendChild(btn);
                });
            }
        },

        checkAnswer(userAnswer, correctAnswer, btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            const feedbackEl = document.getElementById('feedback');
            
            if (userAnswer === correctAnswer) {
                this.sfx.play('correct');
                feedbackEl.innerText = '¬°Correcto! üéâ';
                btn.classList.add('correct');
                
                this.state.correctCount++;
                this.state.stars += 10;
                this.state.sessionStats.correct++;

                if (this.state.correctCount >= 10) {
                    this.sfx.play('levelUp');
                    this.state.level = Math.min(this.state.level + 1, 5);
                    this.state.correctCount = 0;
                    this.state.errorCount = 0;
                    feedbackEl.innerText = '¬°Subiste de nivel! üèÜ';
                }
            } else {
                this.sfx.play('incorrect');
                feedbackEl.innerText = `Era ${correctAnswer} üòÖ`;
                btn.classList.add('incorrect');
                this.state.errorCount++;
                this.state.sessionStats.incorrect++;

                if (this.state.errorCount >= 3) {
                    this.state.level = Math.max(1, this.state.level - 1);
                    this.state.correctCount = 0;
                    this.state.errorCount = 0;
                    feedbackEl.innerText = 'Reforcemos el nivel anterior üí™';
                }
            }
            
            this.ui.updateGameStats();
            
            setTimeout(() => {
                feedbackEl.innerText = '';
                this.ui.updatePlayerInfo();
                this.game.generateProblem();
            }, 1500);
        },
        
        finishGame(isTimeUp) {
            clearInterval(this.state.timerInterval);
            if(isTimeUp) {
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.innerText = "¬°Se acab√≥ el tiempo!";
                setTimeout(() => { feedbackEl.innerText = ""; }, 2000);
            }
            
            const progress = { level: this.state.level, stars: this.state.stars };
            api.saveProgress(this.state.currentUser.name, this.state.currentOperation, progress);

            document.getElementById('summary-stats').innerHTML = `
                <li>‚úîÔ∏è Aciertos: ${this.state.sessionStats.correct}</li>
                <li>‚ùå Errores: ${this.state.sessionStats.incorrect}</li>
                <li>üåü Estrellas Ganadas: ${this.state.sessionStats.correct * 10}</li>
                <li>ÔøΩ Nivel Final: ${this.state.level}</li>
            `;
            this.ui.showView('summary-view');
        },

        returnToDashboard(fromLevelSelect) {
            // Si el usuario vuelve desde la selecci√≥n de nivel, no recargamos su perfil.
            if (fromLevelSelect) {
                 this.ui.showView('dashboard-view');
            } else {
                this.login(this.state.currentUser.name);
            }
        },

        reset() {
            this.state.currentUser = null;
            this.ui.updateUsersList();
            this.ui.showView('login-view');
        },

        confirmClearAllData() {
            this.ui.showModal('¬øBORRAR TODOS LOS DATOS? Esta acci√≥n no se puede deshacer.', async () => {
                await api.clearAll();
                this.reset();
            });
        },
        
        sfx: {
            play(sound) {
                const sfxMap = {
                    correct: document.getElementById('sfx-correct'),
                    incorrect: document.getElementById('sfx-incorrect'),
                    levelUp: document.getElementById('sfx-level-up'),
                };
                if(sfxMap[sound]) {
                   sfxMap[sound].currentTime = 0;
                   sfxMap[sound].play().catch(e => console.warn("SFX disabled by browser."));
                }
            }
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => KukyApp.init());
    </script>
</body>
</html>
ÔøΩ
